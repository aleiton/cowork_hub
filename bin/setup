#!/usr/bin/env ruby
# frozen_string_literal: true

# =============================================================================
# PROJECT SETUP SCRIPT
# =============================================================================
#
# This script automates the setup of a fresh development environment.
# Run it after cloning the repository: `bin/setup`
#
# WHAT IT DOES:
# 1. Installs gem dependencies (bundle install)
# 2. Creates the database
# 3. Runs migrations
# 4. Seeds the database with test data
#
# WHY THIS FILE EXISTS:
# New developers can get up and running with a single command instead of
# following a multi-step setup guide. This reduces onboarding friction
# and ensures everyone sets up the project the same way.
#
# CUSTOMIZATION:
# Add any project-specific setup steps here, such as:
# - Copying .env.example to .env
# - Installing Node dependencies
# - Setting up local SSL certificates
#
# =============================================================================

require 'fileutils'

# Helper method to run system commands
def system!(*args)
  puts "Running: #{args.join(' ')}"
  system(*args) || abort("\n== Command #{args} failed ==")
end

FileUtils.chdir File.expand_path('..', __dir__) do
  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')

  puts "\n== Copying sample files =="
  unless File.exist?('.env')
    if File.exist?('.env.example')
      FileUtils.cp '.env.example', '.env'
      puts 'Created .env from .env.example'
    end
  end

  puts "\n== Preparing database =="
  system! 'bin/rails db:prepare'

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'

  puts "\n== Setup complete! =="
  puts 'You can now run the server with: bin/rails server'
end
